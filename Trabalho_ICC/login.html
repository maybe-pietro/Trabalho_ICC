
<html lang="pt-br">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bem vindo ao site</title>
	<link rel="stylesheet" href="source/style.css">
	<link rel="stylesheet" href="source/login.css">
</head>
<body>
	<header class="main-header">
		<a href="index.html"><img src="source/logo.png" alt="Logo" class="logo-img"></a>
		<nav class="header-nav">
			<a href="index.html" class="header-btn">Voltar para início</a>
		</nav>
	</header>
	<div class="login-container">
		<h2 id="form-title">Login</h2>
		<form id="login-form">
			<label for="login-email">E-mail</label>
			<input type="email" id="login-email" name="email" required>
			<label for="login-password">Senha</label>
			<input type="password" id="login-password" name="password" required>
			<button type="submit">Entrar</button>
			<span class="switch-link" id="show-register">Não tem conta? Cadastre-se</span>
		</form>
		<form id="register-form" style="display:none;">
			<label for="register-nome">Nome</label>
			<input type="text" id="register-nome" name="nome" required>
			<label for="register-sobrenome">Sobrenome</label>
			<input type="text" id="register-sobrenome" name="sobrenome" required>
			<label for="register-email">E-mail</label>
			<input type="email" id="register-email" name="email" required>
			<label for="register-password">Senha</label>
			<input type="password" id="register-password" name="password" required>
			<button type="submit">Cadastrar</button>
			<span class="switch-link" id="show-login">Já tem conta? Faça login</span>
		</form>
		<div id="message"></div>
	</div>
	<script>
	// Alternar entre login e cadastro
	const loginForm = document.getElementById('login-form');
	const registerForm = document.getElementById('register-form');
	const showRegister = document.getElementById('show-register');
	const showLogin = document.getElementById('show-login');
	const formTitle = document.getElementById('form-title');
	const messageDiv = document.getElementById('message');

	showRegister.onclick = () => {
		loginForm.style.display = 'none';
		registerForm.style.display = 'block';
		formTitle.textContent = 'Cadastro';
		messageDiv.textContent = '';
	};
	showLogin.onclick = () => {
		registerForm.style.display = 'none';
		loginForm.style.display = 'block';
		formTitle.textContent = 'Login';
		messageDiv.textContent = '';
	};

	// Se query param mode=register, abre o formulário de registro automaticamente
	const urlParams = new URLSearchParams(window.location.search);
	if (urlParams.get('mode') === 'register') {
		showRegister.click();
	}

	// Função para exibir mensagens
	function showMessage(msg, success=false) {
		messageDiv.textContent = msg;
		messageDiv.className = success ? 'success-message' : 'error-message';
	}

	// Cadastro
	registerForm.onsubmit = async function(e) {
		e.preventDefault();
		const nome = document.getElementById('register-nome').value.trim();
		const sobrenome = document.getElementById('register-sobrenome').value.trim();
		const email = document.getElementById('register-email').value.trim();
		const senha = document.getElementById('register-password').value;
		try {
			const resp = await fetch('http://127.0.0.1:5000/api/registrar', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ nome, sobrenome, email, senha })
			});
			const data = await resp.json();
			if (resp.ok && data.success) {
				showMessage(data.message, true);
				setTimeout(() => {
					showLogin.click();
				}, 1200);
			} else {
				showMessage(data.message || 'Erro ao cadastrar.');
			}
		} catch (err) {
			showMessage('Erro de conexão com o servidor.');
		}
	};

	// Login
	loginForm.onsubmit = async function(e) {
		e.preventDefault();
		const email = document.getElementById('login-email').value.trim();
		const senha = document.getElementById('login-password').value;
		try {
			const resp = await fetch('http://127.0.0.1:5000/api/login', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ email, senha })
			});
			const data = await resp.json();
			if (resp.ok && data.success) {
				showMessage(data.message, true);
				// Simula autenticação local e salva e-mail/nome retornados pelo servidor
				localStorage.setItem('autenticado', '1');
				if (data.user) {
					localStorage.setItem('userEmail', data.user.email);
					// prefer full name if available
					localStorage.setItem('userName', (data.user.nome || '') + (data.user.sobrenome ? ' ' + data.user.sobrenome : ''));
				} else {
					localStorage.setItem('userEmail', email);
				}
				setTimeout(() => { window.location.href = 'painel.html'; }, 800);
			} else {
				showMessage(data.message || 'Erro ao fazer login.');
			}
		} catch (err) {
			showMessage('Erro de conexão com o servidor.');
		}
	};
	</script>
</body>
</html>
